<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sea Horizon Labeling Tool</title>
    <style>
      body {
        font-family: 'Helvetica', 'Arial', sans-serif;
        margin: 0;
        padding: 0;
        background-color: #ffffff;
        color: #000000;
        height: 100vh;
        overflow: hidden;
      }

      .container {
        height: 100vh;
        /* max-width: 1200px; */
        margin: 0 auto;
        background: #ffffff;
        border: 2px solid #000000;
        border-top: none;
        border-bottom: none;
        display: grid;
        grid-template-rows: auto auto auto 1fr auto auto;
        grid-template-areas:
          'header'
          'stats'
          'progress'
          'image'
          'controls'
          'shortcuts';
      }

      .header {
        grid-area: header;
        background: #000000;
        color: #ffffff;
        padding: 20px;
        text-align: center;
        border-bottom: 2px solid #000000;
      }

      .header h1 {
        font-size: 24px;
        font-weight: bold;
        margin: 0 0 5px 0;
        text-transform: uppercase;
      }

      .header p {
        font-size: 14px;
        margin: 0;
        font-weight: bold;
      }

      .stats {
        grid-area: stats;
        display: flex;
        justify-content: space-around;
        padding: 0;
        background: #ffffff;
        border-bottom: 2px solid #000000;
      }

      .stat-item {
        text-align: center;
        padding: 15px 10px;
        border-right: 2px solid #000000;
        flex: 1;
      }

      .stat-item:last-child {
        border-right: none;
      }

      .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #000000;
      }

      .stat-label {
        font-size: 12px;
        color: #000000;
        text-transform: uppercase;
        font-weight: bold;
        margin-top: 3px;
      }

      .progress-container {
        grid-area: progress;
        display: flex;
        align-items: center;
        background: #ffffff;
        border-bottom: 2px solid #000000;
      }

      .progress-text {
        font-size: 14px;
        font-weight: bold;
        text-transform: uppercase;
        margin-right: 20px;
        margin-left: 20px;
      }

      .progress-bar {
        flex: 1;
        height: 16px;
        background: #ffffff;
        border: 1px solid #000000;
        border-top: none;
        border-bottom: none;
      }

      .progress-fill {
        height: 100%;
        background: #000000;
        transition: none;
      }

      .image-container {
        grid-area: image;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        background: #ffffff;
        border-bottom: 2px solid #000000;
        overflow: hidden;
      }

      .image-wrapper {
        position: relative;
        display: inline-block;
        cursor: crosshair;

        border: 2px solid #000000;
        height: 100%;
      }

      .image-wrapper:hover {
        border-color: #000000;
      }

      .image {
        max-height: 100%;
        max-width: 100%;
        width: auto;
        height: auto;
        display: block;
        object-fit: contain;
      }

      .horizon-line {
        position: absolute;
        left: 0;
        right: 0;
        height: 4px;
        background: #ff0000;
        pointer-events: none;
        z-index: 10;
      }

      .horizon-marker {
        position: absolute;
        width: 24px;
        height: 24px;
        background: #ff0000;
        border: 1px solid #000000;
        transform: translate(-50%, -50%);
        pointer-events: none;
        z-index: 11;
      }

      .controls {
        grid-area: controls;
        padding: 20px;
        text-align: center;
        background: #ffffff;
        border-bottom: 2px solid #000000;
      }

      .btn {
        padding: 12px 20px;
        margin: 0 6px;
        border: 1px solid #000000;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        text-transform: uppercase;
        font-family: 'Helvetica', 'Arial', sans-serif;
        transition: none;
      }

      .btn-primary {
        background: #000000;
        color: #ffffff;
      }

      .btn-primary:hover {
        background: #ffffff;
        color: #000000;
      }

      .btn-secondary {
        background: #ffffff;
        color: #000000;
      }

      .btn-secondary:hover {
        background: #000000;
        color: #ffffff;
      }

      .btn-danger {
        background: #ffffff;
        color: #000000;
      }

      .btn-danger:hover {
        background: #000000;
        color: #ffffff;
      }

      .btn-warning {
        background: #ffffff;
        color: #000000;
      }

      .btn-warning:hover {
        background: #000000;
        color: #ffffff;
      }

      .keyboard-shortcuts {
        grid-area: shortcuts;
        display: flex;
        justify-content: center;
        gap: 20px;
        padding: 15px;
        font-size: 14px;
        font-weight: bold;
        background: #ffffff;
      }

      .shortcut {
        display: flex;
        align-items: center;
        gap: 2px;
      }

      .key {
        background: #000000;
        color: #ffffff;
        border: 1px solid #000000;
        padding: 6px 12px;
        font-family: 'Helvetica', 'Arial', sans-serif;
        font-weight: bold;
        font-size: 14px;
        margin-right: 4px;
        margin-left: 4px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #000000;
        font-weight: bold;
        font-size: 16px;
        text-transform: uppercase;
      }

      .error {
        background: #ffffff;
        color: #000000;
        padding: 20px;
        border: 1px solid #000000;
        margin: 20px 0;
        font-weight: bold;
        text-transform: uppercase;
      }

      .success {
        background: #ffffff;
        color: #000000;
        padding: 20px;
        border: 1px solid #000000;
        margin: 20px 0;
        font-weight: bold;
        text-transform: uppercase;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="stats">
        <div class="stat-item">
          <div class="stat-number" id="total">-</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="labeled">-</div>
          <div class="stat-label">Labeled</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="with-horizon">-</div>
          <div class="stat-label">With Horizon</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="bad-images">-</div>
          <div class="stat-label">Bad Images</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="to-label">-</div>
          <div class="stat-label">To Label</div>
        </div>
        <div class="stat-item">
          <div class="stat-number" id="progress">-</div>
          <div class="stat-label">Progress %</div>
        </div>
      </div>

      <div class="progress-container">
        <div class="progress-text">PROGRESS BAR</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
      </div>

      <div class="image-container" id="image-container">
        <div class="loading">Loading next image...</div>
      </div>

      <div class="controls">
        <button class="btn btn-primary" onclick="confirmHorizon()">
          Confirm Horizon (H)
        </button>
        <button class="btn btn-secondary" onclick="skipImage()">
          Skip Image (S)
        </button>
        <button class="btn btn-warning" onclick="undoLastLabel()">
          Undo (U)
        </button>
        <button class="btn btn-danger" onclick="reloadImage()">
          Reload (R)
        </button>
      </div>

      <div class="keyboard-shortcuts">
        <div class="shortcut">
          <span class="key">H</span>
          <span>Confirm horizon and next</span>
        </div>
        <div class="shortcut">
          <span class="key">S</span>
          <span>Skip (no horizon) and next</span>
        </div>
        <div class="shortcut">
          <span class="key">U</span>
          <span>Undo last label</span>
        </div>
        <div class="shortcut">
          <span class="key">R</span>
          <span>Reload current image</span>
        </div>
      </div>
    </div>

    <script>
      let currentImage = null;
      let horizonY = null;
      let imageElement = null;
      let horizonLine = null;
      let horizonMarker = null;

      // Load stats
      async function loadStats() {
        try {
          const response = await fetch('/api/stats');
          const stats = await response.json();

          document.getElementById('total').textContent = stats.total;
          document.getElementById('labeled').textContent = stats.labeled;
          document.getElementById('with-horizon').textContent =
            stats.with_horizon;
          document.getElementById('bad-images').textContent = stats.bad_images;
          document.getElementById('to-label').textContent = stats.to_label;
          document.getElementById('progress').textContent =
            stats.progress + '%';
          document.getElementById('progress-fill').style.width =
            stats.progress + '%';
        } catch (error) {
          console.error('Error loading stats:', error);
        }
      }

      // Load next image
      async function loadNextImage() {
        try {
          const response = await fetch('/api/next-image');
          const data = await response.json();

          if (data.message) {
            document.getElementById(
              'image-container'
            ).innerHTML = `<div class="success">${data.message}</div>`;
            return;
          }

          currentImage = data.image;
          displayImage(currentImage);
          loadStats();
        } catch (error) {
          console.error('Error loading image:', error);
          document.getElementById(
            'image-container'
          ).innerHTML = `<div class="error">Error loading image: ${error.message}</div>`;
        }
      }

      // Display image
      function displayImage(image) {
        const container = document.getElementById('image-container');

        container.innerHTML = `
                 <div class="image-wrapper" id="image-wrapper">
                     <img src="${image.url}" alt="Sea horizon image" class="image" id="image">
                     <div class="horizon-line" id="horizon-line" style="display: none;"></div>
                     <div class="horizon-marker" id="horizon-marker" style="display: none;"></div>
                 </div>
             `;

        imageElement = document.getElementById('image');
        horizonLine = document.getElementById('horizon-line');
        horizonMarker = document.getElementById('horizon-marker');

        // Add click and mouse move events
        const wrapper = document.getElementById('image-wrapper');
        wrapper.addEventListener('click', handleImageClick);
        wrapper.addEventListener('mousemove', handleImageMouseMove);

        // Add keyboard shortcuts
        document.addEventListener('keydown', handleKeyPress);

        // If this is a previously labeled image (from undo), show the existing horizon
        if (image.horizon_y !== null && image.horizon_y !== undefined) {
          horizonY = image.horizon_y;
          const imageHeight = imageElement.offsetHeight;
          const markerY = horizonY * imageHeight;
          horizonLine.style.top = markerY + 'px';
          horizonMarker.style.top = markerY + 'px';
          horizonLine.style.display = 'block';
          horizonMarker.style.display = 'block';
        }
      }

      // Handle image click and mouse move
      function handleImageClick(event) {
        updateHorizonPosition(event);
      }

      function handleImageMouseMove(event) {
        updateHorizonPosition(event);
      }

      function updateHorizonPosition(event) {
        const rect = imageElement.getBoundingClientRect();
        const mouseY = event.clientY - rect.top;
        const imageHeight = rect.height;

        // Normalize Y position (0-1)
        horizonY = Math.max(0, Math.min(1, mouseY / imageHeight));

        // Update visual markers
        const markerY = horizonY * imageHeight;
        horizonLine.style.top = markerY + 'px';
        horizonMarker.style.top = markerY + 'px';
        horizonLine.style.display = 'block';
        horizonMarker.style.display = 'block';
      }

      // Handle keyboard shortcuts
      function handleKeyPress(event) {
        switch (event.key.toLowerCase()) {
          case 'h':
            event.preventDefault();
            confirmHorizon();
            break;
          case 's':
            event.preventDefault();
            skipImage();
            break;
          case 'u':
            event.preventDefault();
            undoLastLabel();
            break;
          case 'r':
            event.preventDefault();
            reloadImage();
            break;
        }
      }

      // Confirm horizon
      async function confirmHorizon() {
        if (!currentImage) return;

        try {
          const response = await fetch('/api/label', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              image_id: currentImage.id,
              horizon_y: horizonY,
              is_labeled: true,
            }),
          });

          if (response.ok) {
            loadNextImage();
          } else {
            throw new Error('Failed to save label');
          }
        } catch (error) {
          console.error('Error saving label:', error);
          alert('Error saving label: ' + error.message);
        }
      }

      // Skip image
      async function skipImage() {
        if (!currentImage) return;

        try {
          const response = await fetch('/api/label', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              image_id: currentImage.id,
              horizon_y: null,
              is_labeled: true,
            }),
          });

          if (response.ok) {
            loadNextImage();
          } else {
            throw new Error('Failed to skip image');
          }
        } catch (error) {
          console.error('Error skipping image:', error);
          alert('Error skipping image: ' + error.message);
        }
      }

      // Reload image
      function reloadImage() {
        if (currentImage) {
          horizonY = null;
          if (horizonLine) horizonLine.style.display = 'none';
          if (horizonMarker) horizonMarker.style.display = 'none';
        }
      }

      // Undo last label
      async function undoLastLabel() {
        try {
          const response = await fetch('/api/undo');
          const data = await response.json();

          if (data.message) {
            alert(data.message);
            return;
          }

          currentImage = data.image;
          displayImage(currentImage);
          loadStats();
        } catch (error) {
          console.error('Error undoing last label:', error);
          alert('Error undoing last label: ' + error.message);
        }
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', function () {
        loadStats();
        loadNextImage();
      });
    </script>
  </body>
</html>
